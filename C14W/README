#!/bin/csh
#

# Generated by CHARMM-GUI (http://www.charmm-gui.org) v3.5
#
# This folder contains GROMACS formatted CHARMM36 force fields, a pre-optimized PDB structure, and GROMACS inputs.
# All input files were optimized for GROMACS 2019.2 or above, so lower version of GROMACS can cause some errors.
# We adopted the Verlet cut-off scheme for all minimization, equilibration, and production steps because it is 
# faster and more accurate than the group scheme. If you have a trouble with a performance of Verlet scheme while 
# running parallelized simulation, you should check if you are using appropriate command line.
# For MPI parallelizing, we recommand following command:
# mpirun -np $NUM_CPU gmx mdrun -ntomp 1

set init = step3_input
set mini_prefix = step4.0_minimization
set equi_prefix = step4.1_equilibration
set prod_prefix = step5_production
set prod_step   = step5

# Minimization
# In the case that there is a problem during minimization using a single precision of GROMACS, please try to use 
# a double precision of GROMACS only for the minimization step.
gmx grompp -f ${mini_prefix}.mdp -o ${mini_prefix}.tpr -c ${init}.gro -r ${init}.gro -p topol.top -n index.ndx -maxwarn -1
gmx_d mdrun -v -deffnm ${mini_prefix} 


gmx grompp -f step4.0_minimization.mdp -o step4.0_minimization.tpr -c step3_input.gro -r step3_input.gro -p topol.top -n index.ndx -maxwarn -1

gmx mdrun -v -deffnm step4.0_minimization


# Equilibration
gmx grompp -f ${equi_prefix}.mdp -o ${equi_prefix}.tpr -c ${mini_prefix}.gro -r ${init}.gro -p topol.top -n index.ndx
gmx mdrun -v -deffnm ${equi_prefix}


gmx grompp -f step4.1_equilibration.mdp -o step4.1_equilibration.tpr -c step4.0_minimization.gro -r step3_input.gro -p topol.top -n index.ndx

gmx mdrun -v -deffnm step4.1_equilibration

# Production
set cnt    = 1
set cntmax = 10

while ( ${cnt} <= ${cntmax} )
    @ pcnt = ${cnt} - 1
    set istep = ${prod_step}_${cnt}
    set pstep = ${prod_step}_${pcnt}

	if ( ${cnt} == 1 ) then
        set pstep = ${equi_prefix}
        gmx grompp -f ${prod_prefix}.mdp -o ${istep}.tpr -c ${pstep}.gro -p topol.top -n index.ndx
	else
        gmx grompp -f ${prod_prefix}.mdp -o ${istep}.tpr -c ${pstep}.gro -t ${pstep}.cpt -p topol.top -n index.ndx
	endif
	gmx mdrun -v -deffnm ${istep}
	@ cnt += 1
end


gmx grompp -f step5_production.mdp -o c14w.tpr -c step4.1_equilibration.gro -t step4.1_equilibration.cpt -p topol.top -n index.ndx

gmx mdrun -v -deffnm c14w


Minimization Plots:
gmx energy -f step4.0_minimization.edr -o potential.xvg
12 0
gmx energy -f step4.0_minimization.edr -o pressure.xvg
13 0
gmx energy -f step4.0_minimization.edr -o constr_rmsd.xvg
14 0


Equilibration Plots:
gmx energy -f step4.1_equilibration.edr -o potential.xvg
12 0
gmx energy -f step4.1_equilibration.edr -o pressure.xvg
17 0
gmx energy -f step4.1_equilibration.edr -o energy.xvg
14 0
gmx energy -f step4.1_equilibration.edr -o temperature.xvg
16 0
gmx energy -f step4.1_equilibration.edr -o constr_rmsd.xvg
18 0
gmx energy -f step4.1_equilibration.edr -o kinetic_energy.xvg
13 0


c14w Plots:
gmx energy -f c14w.edr -o potential.xvg
11 0
gmx energy -f c14w.edr -o pressure.xvg
15 0
gmx energy -f c14w.edr -o energy.xvg
13 0
gmx energy -f c14w.edr -o density.xvg
21 0
gmx energy -f c14w.edr -o volume.xvg
20 0
gmx energy -f c14w.edr -o temperature.xvg
14 0
gmx energy -f c14w.edr -o enthalpy.xvg
23 0
gmx energy -f c14w.edr -o constr_rmsd.xvg
16 0
gmx energy -f c14w.edr -o kinetic_energy.xvg
12 0

Trjconv module to account for any periodicity in the system
gmx trjconv -s c14w.tpr -f c14w.xtc -o c14w_new.xtc -pbc mol -center
1 1

-RMSD-Root Mean Square Diviation:
gmx rms -s c14w.tpr -f c14w_new.xtc -o rmsd.xvg -tu ns
1 1

-RMSF-Root Mean Square Fluctuation:
gmx rmsf -s c14w.tpr -f c14w_new.xtc -o rmsf.xvg

Radius of Gyration:
gmx gyrate -s c14w.tpr -f c14w_new.xtc -o gyrate.xvg

Visualize the simulation using VMD:
vmd c14w.gro c14w_new.xtc

